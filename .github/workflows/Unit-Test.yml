---
name: Run Unit Tests on PR
on: workflow_call
jobs:
  container_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dump github context
        run: echo "$GITHUB_CONTEXT"
        shell: bash
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
      - name: Unit Tests
        run: |
            tee unit_test.sh <<EOF
            crew update
            yes | crew upgrade
            yes | crew install vim
            yes | crew remove vim
            ruby ../tests/prop_test
            ruby ../tests/buildsystem_test
            ruby ../tests/commands/const.rb
            ruby ../tests/commands/help.rb
            ruby ../tests/commands/prop.rb
            cd ~
            git clone --depth=1 https://github.com/chromebrew/chromebrew.git
            cd chromebrew
            yes | crew build -f packages/hello_world_chromebrew.rb
            EOF
            chmod +x ./unit_test.sh
            sudo docker run -v $(pwd)/unit_test.sh:/usr/local/lib/crew/packages/unit_test.sh -e CREW_REPO=${{ github.event.pull_request.head.repo.clone_url}} -e CREW_BRANCH=${{ github.head_ref }} -e CREW_SCRIPTING=1 -t satmandu/crewbuild:amd64 sudo -i -u chronos /bin/bash unit_test.sh
