---
name: Run Unit Tests on PR
on: workflow_call
jobs:
  container_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Dump github context
        run: echo "$GITHUB_CONTEXT"
        shell: bash
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
      - name: Get all changed package files
        id: changed-ruby-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
             packages/*.rb
      - name: List all changed package files
        uses: tj-actions/changed-files@v44
        if: steps.changed-ruby-files.outputs.any_changed == 'true'
      - name: Unit Tests (x86_64)
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-ruby-files.outputs.all_changed_files }}
        run: |
            echo "ALL_CHANGED FILES is ${ALL_CHANGED_FILES}." && \
            export CHANGED_PACKAGES="$(echo ${ALL_CHANGED_FILES#packages/} | tr -d '.rb' | sort)" && \
            echo "CHANGED PACKAGES is ${CHANGED_PACKAGES}." && \
            sudo docker run --rm \
            -e ALL_CHANGED_FILES="${ALL_CHANGED_FILES}" \
            -e CHANGED_PACKAGES="${CHANGED_PACKAGES}" \
            -i satmandu/crewbuild:m90-x86_64 \
            sudo -i -u chronos /bin/bash -x -c " \
            export ALL_CHANGED_FILES=\"${ALL_CHANGED_FILES}\" && \
            export CHANGED_PACKAGES=\"${CHANGED_PACKAGES}\" \
            echo \"CREW_REPO is ${{ github.event.pull_request.head.repo.clone_url }}\" && \
            echo \"CREW_BRANCH is ${{ github.head_ref }}\" && \
            CREW_REPO=${{ github.event.pull_request.head.repo.clone_url }} CREW_BRANCH=${{ github.head_ref }} crew update && \
            /usr/local/lib/crew/tests/unit_test.sh"
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        # This is not the best way to do things, a matrix would certainly be better.
      - name: Unit Tests (armv7l)
        env:
          ALL_CHANGED_FILES: ${{ steps.changed-ruby-files.outputs.all_changed_files }}
        run: |
            echo "ALL_CHANGED FILES is ${ALL_CHANGED_FILES}." && \
            export CHANGED_PACKAGES="$(echo ${ALL_CHANGED_FILES#packages/} | tr -d '.rb' | sort)" && \
            echo "CHANGED PACKAGES is ${CHANGED_PACKAGES}." && \
            echo sudo docker run --rm \
            -e ALL_CHANGED_FILES="${ALL_CHANGED_FILES}" \
            -e CHANGED_PACKAGES="${CHANGED_PACKAGES}" \
            sudo docker run --rm \
            --platform linux/arm/v7 -t satmandu/crewbuild:m91-armv7l \
            sudo -i -u chronos /bin/bash -x -c " \
            export ALL_CHANGED_FILES=\"${ALL_CHANGED_FILES}\" && \
            export CHANGED_PACKAGES=\"${CHANGED_PACKAGES}\" \
            echo \"CREW_REPO is ${{ github.event.pull_request.head.repo.clone_url }}\" && \
            echo \"CREW_BRANCH is ${{ github.head_ref }}\" && \
            CREW_REPO=${{ github.event.pull_request.head.repo.clone_url }} CREW_BRANCH=${{ github.head_ref }} crew update && \
            /usr/local/lib/crew/tests/unit_test.sh"
